<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>任务处理器</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        #console {
            width: 100%;
            height: 200px;
            border: 1px solid #ccc;
            overflow-y: scroll;
            padding: 10px;
            background-color: #f0f0f0;
        }
        .progress-bar {
            width: 100%;
            height: 20px;
            background-color: #e0e0e0;
            margin-top: 10px;
        }
        .progress {
            height: 100%;
            background-color: green;
            text-align: center;
            color: white;
            line-height: 20px;
        }
        .status {
            margin-top: 10px;
            font-size: 16px;
            font-weight: bold;
        }
        .status span {
            color: gray;
        }
    </style>
</head>
<body>
    <h1>异步任务处理器</h1>
    <button id="startBtn">开始处理</button>
    初始mock概率
    <input type="number" id="successRate" placeholder="设置成功率(0-100)" min="0" max="100" value="90"> % <br>
    <div id="console"></div>
    <div class="progress-bar">
        <div id="progress" class="progress" style="width: 0%">0%</div>
    </div>
    <div class="status">
        状态: <span id="taskStatus">空闲</span>
    </div>

    <script>
        document.getElementById("startBtn").addEventListener("click", onStartBtnClick);

        async function onStartBtnClick() {
            updateStatus("进行中...");
            log("开始任务处理...");

            try {
                const config = await loadConfig();
                log("配置已加载。");
                await processFiles(config);  // 顺序加载
                await initSystem();
                log("系统初始化完成。");
                updateStatus("已完成");
            } catch (error) {
                log(`错误: ${error}`);
                updateStatus("失败");
            }
        }

        async function loadConfig() {
            log("加载配置...");
            return new Promise((resolve) => {
                setTimeout(() => {
                    const files = ["file1.txt", "file2.txt", "file3.txt", "file4.txt", "file5.txt"];
                    resolve(files); // 模拟文件列表
                }, 1000);
            });
        }

        async function loadFile(file) {
            log(`正在加载文件: ${file}`);
            let attempts = 0;
            const maxAttempts = 3;
            const baseDelay = 1000; // 基准延迟时间为 1 秒（1000 毫秒）
            const successRate = document.getElementById("successRate").value / 100; // 获取设置的成功率

            while (attempts < maxAttempts) {
                try {
                    await new Promise((resolve, reject) => {
                        const timeout = 5000; // 5秒超时
                        const timer = setTimeout(() => reject("超时"), timeout);
                        const randomDelay = Math.random() * 2000 + 1000; // 模拟 1-3 秒的随机延迟
                        setTimeout(() => {
                            clearTimeout(timer);
                            if (Math.random() < successRate) resolve(); // 根据用户设置的成功率决定是否成功
                            else reject("加载文件失败");
                        }, randomDelay);
                    });
                    log(`文件加载成功: ${file}`);
                    return;
                } catch (error) {
                    log(`加载文件 ${file} 错误: ${error}`);
                    attempts++;
                    if (attempts < maxAttempts) {
                        const delayTime = baseDelay * Math.pow(2, attempts); // 指数回退
                        log(`正在重试加载文件 ${file}，等待 ${delayTime} 毫秒...`);
                        await new Promise(resolve => setTimeout(resolve, delayTime)); // 等待指数回退时间
                    }
                }
            }
            throw new Error(`加载文件 ${file} 失败，已尝试 ${maxAttempts} 次。`);
        }

        async function processFiles(files) {
            let completedLoads = 0;
            for (let i = 0; i < files.length; i++) {
                await loadFile(files[i]); // 顺序加载
                completedLoads++;
                updateProgress(completedLoads, files.length);  // 更新进度
            }
        }

        async function initSystem() {
            log("正在初始化系统...");
            await new Promise(resolve => setTimeout(resolve, 1000));
            log("系统初始化完成。");
        }

        function log(message) {
            const consoleElement = document.getElementById("console");
            const messageElement = document.createElement("div");
            messageElement.textContent = message;
            consoleElement.appendChild(messageElement);
            consoleElement.scrollTop = consoleElement.scrollHeight; // 滚动到底部
        }

        function updateProgress(completed, total) {
            const progress = Math.floor((completed / total) * 100);
            const progressElement = document.getElementById("progress");
            progressElement.style.width = `${progress}%`;
            progressElement.textContent = `${progress}%`;
        }

        function updateStatus(status) {
            const statusElement = document.getElementById("taskStatus");
            statusElement.textContent = status;
        }
    </script>
</body>
</html>
